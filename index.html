<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TempMail - Debug Friendly</title>
  <style>
    body{font-family:system-ui,Arial;margin:18px;background:#0f1724;color:#e6eef8}
    .card{max-width:920px;margin:0 auto;background:#0b1220;padding:16px;border-radius:12px;border:1px solid #273149}
    h1{margin:0 0 12px;font-size:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #243046;background:#1f2a44;color:#e6eef8;cursor:pointer}
    .btn.primary{background:#6ea8fe;color:#012036;border:none}
    .emailBox{background:#071026;padding:10px;border-radius:8px;border:1px dashed #223042;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .email{font-weight:700;color:#9fc7ff}
    #inbox{margin-top:12px;border-collapse:collapse;width:100%}
    th,td{padding:10px;border-bottom:1px solid #1b2536;text-align:left}
    th{color:#bfc9e0}
    .muted{color:#9aa5c2;font-size:13px}
    #error{margin-top:10px;color:#ffb4b4;background:#3b1b1b;padding:8px;border-radius:8px;display:none}
    pre{white-space:pre-wrap;background:#081025;padding:10px;border-radius:8px;color:#cfe9ff;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ•’ TempMail (debug build)</h1>
    <div class="row">
      <button class="btn primary" id="genBtn">Generate Email</button>
      <button class="btn" id="refreshBtn">Refresh Inbox</button>
      <div class="muted" id="status">Status: idle</div>
    </div>

    <div class="emailBox">
      <div class="muted">Your temp email:</div>
      <div id="email" class="email">â€”</div>
      <button class="btn" id="copyBtn">Copy</button>
    </div>

    <table id="inbox" aria-live="polite">
      <thead><tr><th>From</th><th>Subject</th><th>ID</th><th>Date</th></tr></thead>
      <tbody id="inboxBody"><tr><td colspan="4" class="muted">No inbox yet.</td></tr></tbody>
    </table>

    <div id="error"><strong>Error:</strong><div id="errText"></div></div>

    <div style="margin-top:12px" class="muted">
      Tip: Agar "CORS" error aaye to proxy ya backend chahiye. Agar tum chaho to main tumhare liye simple proxy (free) bana dunga.
    </div>
    <div style="margin-top:8px" class="muted">
      Local test: agar PC pe ho to run `python3 -m http.server 8000` aur phir visit <code>http://localhost:8000</code>
    </div>
  </div>

<script>
const proxies = [
  url => url, // direct first (fast if CORS allowed)
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://thingproxy.freeboard.io/fetch/${url}`,
  url => `https://cors.bridged.cc/${url}`
];

// helper: try multiple proxies until one returns valid JSON
async function fetchJsonWithFallback(url) {
  let lastErr = null;
  for (const makeUrl of proxies) {
    const attemptUrl = makeUrl(url);
    console.log('Trying proxy:', attemptUrl);
    try {
      const res = await fetch(attemptUrl);
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      // Try res.json() first (works for most proxies)
      try {
        const data = await res.json();
        return data;
      } catch (e) {
        // If json() fails, try text then parse
        const text = await res.text();
        // Some proxies (allorigins / others) sometimes return a wrapper: {contents: "..."}
        try {
          // first try parsing raw text
          return JSON.parse(text);
        } catch (e2) {
          try {
            const wrapper = JSON.parse(text);
            if (wrapper && wrapper.contents) {
              return JSON.parse(wrapper.contents);
            }
          } catch (e3) {
            // not JSON â€” treat as failure for this proxy
            throw new Error('Proxy returned non-JSON');
          }
        }
      }
    } catch (err) {
      console.warn('Proxy failed:', attemptUrl, err.message || err);
      lastErr = `${attemptUrl} â†’ ${err.message || err}`;
      // try next proxy
    }
  }
  throw new Error(lastErr || 'All proxies failed');
}

// UI refs
const genBtn = document.getElementById('genBtn');
const refreshBtn = document.getElementById('refreshBtn');
const emailEl = document.getElementById('email');
const inboxBody = document.getElementById('inboxBody');
const statusEl = document.getElementById('status');
const errBox = document.getElementById('error');
const errText = document.getElementById('errText');
const copyBtn = document.getElementById('copyBtn');

let currentEmail = '';
let login = '', domain = '';

function showError(msg) {
  errBox.style.display = 'block';
  errText.textContent = msg;
  statusEl.textContent = 'Status: error';
}

function clearError() {
  errBox.style.display = 'none';
  errText.textContent = '';
}

function setStatus(s) {
  statusEl.textContent = 'Status: ' + s;
}

genBtn.onclick = async () => {
  clearError();
  setStatus('generating...');
  inboxBody.innerHTML = `<tr><td colspan="4" class="muted">Generating emailâ€¦</td></tr>`;
  const url = 'https://www.1secmail.com/api/v1/?action=genRandomMailbox&count=1';
  try {
    const data = await fetchJsonWithFallback(url);
    // data should be an array like ["abc@1secmail.com"]
    if (Array.isArray(data) && data.length>0 && typeof data[0]==='string') {
      currentEmail = data[0];
      [login, domain] = currentEmail.split('@');
      emailEl.textContent = currentEmail;
      setStatus('generated');
      inboxBody.innerHTML = `<tr><td colspan="4" class="muted">Click "Refresh Inbox" to load messages.</td></tr>`;
    } else {
      throw new Error('Unexpected API response: ' + JSON.stringify(data));
    }
  } catch (err) {
    showError('Generate failed: ' + (err.message || err));
    inboxBody.innerHTML = `<tr><td colspan="4" class="muted">Generation failed.</td></tr>`;
  }
};

refreshBtn.onclick = async () => {
  clearError();
  if (!currentEmail) return alert('Please generate an email first.');
  setStatus('loading inbox...');
  inboxBody.innerHTML = `<tr><td colspan="4" class="muted">Loadingâ€¦</td></tr>`;
  const url = `https://www.1secmail.com/api/v1/?action=getMessages&login=${encodeURIComponent(login)}&domain=${encodeURIComponent(domain)}`;
  try {
    const msgs = await fetchJsonWithFallback(url);
    if (!Array.isArray(msgs) || msgs.length===0) {
      inboxBody.innerHTML = `<tr><td colspan="4" class="muted">No emails yet (or API blocked sending domain).</td></tr>`;
      setStatus('no messages');
      return;
    }
    inboxBody.innerHTML = '';
    msgs.sort((a,b)=> new Date(b.date) - new Date(a.date));
    for (const m of msgs) {
      const tr = document.createElement('tr');
      const from = escapeHtml(m.from || '');
      const subj = escapeHtml(m.subject || '(no subject)');
      tr.innerHTML = `<td>${from}</td>
                      <td><a href="#" data-id="${m.id}" class="readLink">${subj}</a></td>
                      <td>${m.id}</td>
                      <td>${m.date || ''}</td>`;
      inboxBody.appendChild(tr);
    }
    setStatus('inbox loaded');
    // attach read handlers
    document.querySelectorAll('.readLink').forEach(a=>{
      a.onclick = async (ev) => {
        ev.preventDefault();
        const id = a.dataset.id;
        await openMessage(id);
      };
    });
  } catch (err) {
    showError('Load inbox failed: ' + (err.message || err));
    inboxBody.innerHTML = `<tr><td colspan="4" class="muted">Failed to load inbox.</td></tr>`;
  }
};

async function openMessage(id) {
  clearError();
  setStatus('loading message ' + id);
  const url = `https://www.1secmail.com/api/v1/?action=readMessage&login=${encodeURIComponent(login)}&domain=${encodeURIComponent(domain)}&id=${id}`;
  try {
    const mail = await fetchJsonWithFallback(url);
    // show modal-like alert with mail (simple)
    const content = `From: ${mail.from || ''}\nSubject: ${mail.subject || ''}\nDate: ${mail.date || ''}\n\n${mail.textBody || mail.htmlBody || '(no body)'}`;
    alert(content);
    setStatus('message viewed');
  } catch (err) {
    showError('Read message failed: ' + (err.message || err));
  }
}

copyBtn.onclick = () => {
  if (!currentEmail) return alert('Generate first.');
  navigator.clipboard?.writeText(currentEmail).then(()=> alert('Copied: ' + currentEmail)).catch(()=> alert('Copy failed, select and copy manually.'));
};

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// For debugging: if generation fails, show console error text (helpful to paste here)
window.showConsoleError = (msg) => {
  showError(msg);
};
</script>
</body>
</html>
